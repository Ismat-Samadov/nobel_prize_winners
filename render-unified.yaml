services:
  # Single unified service that serves both frontend and backend
  - type: web
    name: active-learning-ner
    env: python
    buildCommand: |
      # Update system and install required packages
      apt-get update
      apt-get install -y curl build-essential
      
      # Install Node.js 18
      curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      apt-get install -y nodejs
      
      # Install Rust (needed for some Python packages)
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      export PATH="$HOME/.cargo/bin:$PATH"
      
      # Create a simplified requirements file without problematic packages
      cat > api/requirements_simple.txt << EOF
      fastapi==0.104.1
      uvicorn[standard]==0.24.0
      pydantic==2.5.0
      python-multipart==0.0.6
      aiofiles==23.2.1
      numpy>=1.21.0
      pandas>=1.3.0
      scikit-learn>=1.0.0
      matplotlib>=3.4.0
      seaborn>=0.11.0
      Pillow>=8.3.0
      requests>=2.25.0
      python-jose[cryptography]==3.3.0
      passlib[bcrypt]==1.7.4
      EOF
      
      # Install Python dependencies (without heavy ML packages for now)
      pip install --upgrade pip
      pip install -r api/requirements_simple.txt
      
      # Build frontend
      cd frontend
      npm ci --only=production
      npm run build
      cd ..
      
      # Move frontend build to serve from FastAPI
      mkdir -p api/static
      cp -r frontend/build/* api/static/
      
    startCommand: |
      cd api
      uvicorn main_unified_simple:app --host 0.0.0.0 --port $PORT
      
    envVars:
      - key: PYTHONPATH
        value: /opt/render/project/src:/opt/render/project/src/api
      - key: NODE_ENV
        value: production
        
    plan: free